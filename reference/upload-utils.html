<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Utilities for artifact upload — initializeUpload • zircon</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Utilities for artifact upload — initializeUpload"><meta property="og:description" content="Utilities for uploading files to an ArtifactDB instance, used internally by uploadProject."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">zircon</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.98.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/userguide.html">R client for an ArtifactDB API</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"></ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Utilities for artifact upload</h1>
    
    <div class="hidden name"><code>upload-utils.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Utilities for uploading files to an ArtifactDB instance, used internally by <code><a href="uploadProject.html">uploadProject</a></code>.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">initializeUpload</span><span class="op">(</span></span>
<span>  <span class="va">dir</span>,</span>
<span>  <span class="va">files</span>,</span>
<span>  <span class="va">start.url</span>,</span>
<span>  dedup.md5 <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dedup.md5.field <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  dedup.link <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  expires <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  user.agent <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">createUploadStartURL</span><span class="op">(</span><span class="va">url</span>, <span class="va">project</span>, <span class="va">version</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">uploadFiles</span><span class="op">(</span><span class="va">dir</span>, <span class="va">url</span>, <span class="va">initial</span>, user.agent <span class="op">=</span> <span class="cn">NULL</span>, attempts <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">completeUpload</span><span class="op">(</span></span>
<span>  <span class="va">url</span>,</span>
<span>  <span class="va">initial</span>,</span>
<span>  index.wait <span class="op">=</span> <span class="fl">600</span>,</span>
<span>  must.index <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  permissions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  overwrite.permissions <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  user.agent <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">abortUpload</span><span class="op">(</span><span class="va">url</span>, <span class="va">initial</span>, user.agent <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>dir</dt>
<dd><p>String containing the path to a project directory on the file system, containing files to be uploaded.</p></dd>


<dt>files</dt>
<dd><p>Character vector of paths to files to be uploaded within <code>dir</code>.
These should be relative to <code>dir</code>.</p></dd>


<dt>start.url</dt>
<dd><p>String containing the URL to the upload endpoint.</p></dd>


<dt>dedup.md5</dt>
<dd><p>Named character vector containing the MD5 sums of files that are potentially duplicated in the ArtifactDB backend.
Each name in the vector should be a relative path to a file in <code>dir</code>, while each value of the vector should be its MD5 sum.
Names should not overlap with entries in <code>files</code>.</p></dd>


<dt>dedup.md5.field</dt>
<dd><p>String specifying the name of the metadata field containing the MD5 sum in existing ArtifactDB entries.
Must be specified if <code>dedup.md5</code> is used.</p></dd>


<dt>dedup.link</dt>
<dd><p>Named character vector specifying which files are duplicates of resources in existing ArtifactDB IDs. 
Each name in the vector should be a relative path to a file in <code>dir</code>, while each value of the vector should be the existing ArtifactDB ID.
Names should not overlap with entries in <code>files</code>.</p></dd>


<dt>expires</dt>
<dd><p>Integer scalar specifying the number of days before the files expire and are removed from the ArtifactDB instance.
By default, the files have no expiry date.</p></dd>


<dt>user.agent</dt>
<dd><p>String containing a user agent string.
If <code>NULL</code>, a default user agent is used.</p></dd>


<dt>url</dt>
<dd><p>String containing the URL to the REST API.</p></dd>


<dt>project</dt>
<dd><p>String containing the project name.</p></dd>


<dt>version</dt>
<dd><p>String containing the version.</p></dd>


<dt>initial</dt>
<dd><p>The response object returned by <code>initializeUpload</code>, or a list generated by calling <code><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></code> on the response.</p></dd>


<dt>attempts</dt>
<dd><p>Integer scalar specifying the number of upload attempts on each file, in case of connection drops or timeouts.
Each attempt is followed by a 1 minute wait.</p></dd>


<dt>index.wait</dt>
<dd><p>Numeric scalar specifying the number of seconds to wait when checking for correct indexing.</p></dd>


<dt>must.index</dt>
<dd><p>Logical scalar indicating whether to throw an error if the indexing is not successful.
If <code>FALSE</code>, a warning is raised if the indexing times out (but an error will still be raised if the indexing explicitly fails).</p></dd>


<dt>permissions</dt>
<dd><p>A list containing permission information, see <code><a href="getPermissions.html">getPermissions</a></code>.
This usually contains the <code>owners</code> and <code>viewers</code> character vectors.</p></dd>


<dt>overwrite.permissions</dt>
<dd><p>Logical scalar indicating whether existing permissions should be overwritten.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p><code>initializeUpload</code> will return the <code>response</code> object from hitting the upload endpoint.
This will have already been checked for failure.
If parsed as JSON, this produces a list with either presigned URL or link URL for each file, depending on whether deduplication was requested and successful.</p>


<p><code>uploadFiles</code> will upload all files to their URLs and return <code>NULL</code>.</p>


<p><code>requestCompletion</code> will return the <code>response</code> object from hitting the completion endpoint.
This will have already been checked for failure.</p>


<p><code>abortUrl</code> will return the <code>response</code> object from hitting the abort endpoint.
This will <em>not</em> have been checked for failure, not least because this function is typically called in response to other errors during the upload;
we leave it to the caller to decide whether to add another error to the trace.</p>


<p><code>createUploadStartUrl</code> will create the “standard” upload URL to be used in <code>start.url</code>.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Use of these utilities will almost always require appropriate authentication/authorization with the target API.
Developers should ensure that <code><a href="authorizedVerb.html">identityHeaders</a></code> and friends are set accordingly.</p>
<p>Setting <code>expires</code> in <code>initializeUpload</code> is useful for testing the upload procedure without creating a permanent copy of the files.
Project versions created with <code>expires</code> will be automatically removed after the expiry interval, freeing up space for real data.</p>
    </div>
    <div id="linking-to-duplicate-files">
    <h2>Linking to duplicate files</h2>
    

<p>ArtifactDB instances are capable of creating links to represent identical files, similar to symbolic links on a typical file system.
This avoids the need to explicitly store a duplicate copy of a file in another project or version.
It is particularly useful when dealing with new project versions where only a subset of files have changed.</p>
<p>The first deduplication mechanism is implicit and based on the MD5 checksum in <code>dedup.md5</code>.
When used in <code>initializeUpload</code>, the ArtifactDB backend will check the most recent previous version of the project (if any exists) for files with the same path and checksum.
If such files are found, the backend will automatically create a link to that file in the previous version, avoiding the need to upload a new copy in <code>uploadFiles</code>.</p>
<p>The second mechanism in <code>dedup.link</code> is more explicit, relying on the uploader to supply the ArtifactDB identifier of the existing file to be linked to.
This involves a bit more work as it requires the uploader to keep track of the duplication.
However, it is also more powerful than the MD5-based method as it can be used to link files across different projects.</p>
<p>Developers can check that the links (especially those from <code>dedup.md5</code>) were created by inspecting the <code>contents</code> of the <code>initializeUpload</code> output.
If the to-be-linked file appears in the <code>links</code> field, the link was created; otherwise, the file must be uploaded via the <code>presigned_urls</code>.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="uploadProject.html">uploadProject</a></code>, for a more user-friendly wrapper around these utilities.</p></div>
    </div>
    <div id="author">
    <h2>Author</h2>
    <p>Aaron Lun</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Creating a mock project.</span></span></span>
<span class="r-in"><span><span class="va">src</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"scripts"</span>, <span class="st">"mock.R"</span>, package<span class="op">=</span><span class="st">"zircon"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="va">src</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">createMockProject</span><span class="op">(</span><span class="va">tmp</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">tmp</span>, recursive<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">f</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "blah.txt"         "blah.txt.json"    "foo/bar.txt"      "foo/bar.txt.json"</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [5] "whee.txt"         "whee.txt.json"   </span>
<span class="r-in"><span><span class="va">start.url</span> <span class="op">&lt;-</span> <span class="fu">createUploadStartURL</span><span class="op">(</span><span class="va">example.url</span>, <span class="st">"test-zircon-upload"</span>, <span class="st">"base2"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">start.url</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "https://gypsum-test.aaron-lun.workers.dev/projects/test-zircon-upload/version/base2/upload"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Basic upload sequence, for testing:</span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">initializeUpload</span><span class="op">(</span><span class="va">tmp</span>, <span class="va">f</span>, <span class="va">start.url</span>, expires<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">uploadFiles</span><span class="op">(</span><span class="va">tmp</span>, <span class="va">example.url</span>, <span class="va">parsed</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">completeUpload</span><span class="op">(</span><span class="va">example.url</span>, <span class="va">parsed</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Demonstrating how to create links:</span></span></span>
<span class="r-in"><span><span class="va">actual.files</span> <span class="op">&lt;-</span> <span class="va">f</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/startsWith.html" class="external-link">endsWith</a></span><span class="op">(</span><span class="va">f</span>, <span class="st">".json"</span><span class="op">)</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">md5</span> <span class="op">&lt;-</span> <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span>file<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">tmp</span>, <span class="va">actual.files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">md5</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">actual.files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">explicit</span> <span class="op">&lt;-</span> <span class="fu"><a href="unpackID.html">packID</a></span><span class="op">(</span><span class="va">example.project</span>, <span class="va">actual.files</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">example.version</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explicit</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">actual.files</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span><span class="va">start.url</span> <span class="op">&lt;-</span> <span class="fu">createUploadStartURL</span><span class="op">(</span><span class="va">example.url</span>, <span class="st">"test-zircon-upload"</span>, <span class="st">"relinked"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">init</span> <span class="op">&lt;-</span> <span class="fu">initializeUpload</span><span class="op">(</span><span class="va">tmp</span>, start.url<span class="op">=</span><span class="va">start.url</span>, expires<span class="op">=</span><span class="fl">1</span>,</span></span>
<span class="r-in"><span>    files<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sets.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">f</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">md5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">explicit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    dedup.md5<span class="op">=</span><span class="va">md5</span>, dedup.md5.field<span class="op">=</span><span class="st">"md5sum"</span>, dedup.link<span class="op">=</span><span class="va">explicit</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">parsed</span> <span class="op">&lt;-</span> <span class="fu">httr</span><span class="fu">::</span><span class="fu"><a href="https://httr.r-lib.org/reference/content.html" class="external-link">content</a></span><span class="op">(</span><span class="va">init</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">uploadFiles</span><span class="op">(</span><span class="va">tmp</span>, <span class="va">example.url</span>, <span class="va">parsed</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">completeUpload</span><span class="op">(</span><span class="va">example.url</span>, <span class="va">parsed</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Aaron Lun.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer></div>

  


  

  </body></html>

